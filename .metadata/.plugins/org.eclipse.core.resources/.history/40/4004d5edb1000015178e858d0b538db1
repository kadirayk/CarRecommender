package database;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.HashMap;

import model.Car;

public class DatabaseHelper {

	public static final String DRIVER = "org.apache.derby.jdbc.EmbeddedDriver";
	public static final String JDBC_CREATE_URL = "jdbc:derby:carrecommenderdb;create=true";
	
	
	public void createCarsTable() throws ClassNotFoundException{
		
		Class.forName(DRIVER);
		Connection connection;
		
		try {
			connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("create table cars(title varchar(300),"
					+ " brand varchar(30),"
					+ " model varchar(30),"
					+ " modeldetail varchar(30),"
					+ " product_year INT,"
					+ " car_km INT,"
					+ " color varchar(30),"
					+ " price INT,"
					+ " city varchar(30),"
					+ " town varchar(30))");
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				//table already exists
				return;
			}
		}
		
	}
	
	public void createBrandsTable() throws ClassNotFoundException{
		
		Class.forName(DRIVER);
		Connection connection;
		
		try {
			connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("create table brands(username varchar(30),"
					+ " brandkey varchar(30),"
					+ " brandvalue INT)");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
		}
		
	}
	
	public void createYearsTable() throws ClassNotFoundException{
		
		Class.forName(DRIVER);
		Connection connection;
		
		try {
			connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("create table years(username varchar(30),"
					+ " yearkey INT, "
					+ " yearvalue INT)");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				//table already exists
				return;
			}
		}
		
	}
	
	
	public void createColorsTable() throws ClassNotFoundException{
		
		Class.forName(DRIVER);
		Connection connection;
		
		try {
			connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("create table colors(username varchar(30),"
					+ " colorkey varchar(30), "
					+ " colorvalue INT)");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				//table already exists
				return;
			}
		}
		
	}
	
	public void createCitiesTable() throws ClassNotFoundException{
		
		Class.forName(DRIVER);
		Connection connection;
		
		try {
			connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("create table cities(username varchar(30),"
					+ " citykey varchar(30), "
					+ " cityvalue INT)");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				//table already exists
				return;
			}
		}
		
	}
	
	public void createKmsTable() throws ClassNotFoundException{
		
		Class.forName(DRIVER);
		Connection connection;
		
		try {
			connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("create table kms(username varchar(30),"
					+ " km_max INT, "
					+ " km_min INT)");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				//table already exists
				return;
			}
		}
		
	}

	public void createPricesTable() throws ClassNotFoundException{
		
		Class.forName(DRIVER);
		Connection connection;

		try {
			connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("create table prices(username varchar(30),"
					+ " price_max INT, "
					+ " price_min INT)");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				//table already exists
				return;
			}
		}
		
	}
	
	
	public void createDB() throws ClassNotFoundException{

	
		createCarsTable();
		createBrandsTable();
		createYearsTable();
		createColorsTable();
		createCitiesTable();
		createKmsTable();
		createPricesTable();
		
		
	}
	
	
	public void insertUserBrandsIntoDB(String userName, String brandKey, int brandValue){
		
		try {
			Connection connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("insert into brands values "
					+ "('"+ userName + "',"
					+ " '" + brandKey + "',"
					+ "" + brandValue + ")");
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				e.printStackTrace();
				return;
			}
			e.printStackTrace();
		}
	
	}
	

	public HashMap<String, Integer> getBrandsMapFromDB(String userName) throws SQLException{
		Connection connection = DriverManager.getConnection(JDBC_CREATE_URL);
		Statement statement = connection.createStatement();
		ResultSet resultset = statement.executeQuery("select * from brands where username = '" + userName + "'");
		
		System.out.println("DB QUERY Brands RESULT---------------------------");
		
		
		HashMap<String, Integer> brands = new HashMap<String, Integer>();
		
		while (resultset.next()){
			brands.put(resultset.getString(2), resultset.getInt(3));
		}
		
		if(statement != null)
			statement.close();
		if(connection != null)
			connection.close();
		
		return brands;
	}
	
	
	
	public void insertCarIntoDB(Car mCar){
		try {
			Connection connection = DriverManager.getConnection(JDBC_CREATE_URL);
			connection.createStatement().execute("insert into cars values "
					+ "('"+ mCar.getTitle() + "',"
					+ " '" + mCar.getBrand() + "',"
					+ " '" + mCar.getModel() + "',"
					+ " '" + mCar.getModelDetail() + "',"
					+  mCar.getYear() + ","
					+ mCar.getKm() + ","
					+ " '" + mCar.getColor() + "',"
					+ mCar.getPrice() + ","
					+ " '" + mCar.getCity() + "',"
					+ " '" + mCar.getTown() +"')");
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			if(e.getErrorCode() == 30000){
				return;
			}
			e.printStackTrace();
		}
		
	}
	
	public ArrayList<Car> getCarListFromDB() throws SQLException{
		Connection connection = DriverManager.getConnection(JDBC_CREATE_URL);
		Statement statement = connection.createStatement();
		ResultSet resultset = statement.executeQuery("select * from cars");
		
		System.out.println("DB QUERY RESULT---------------------------");
		
		ArrayList<Car> carList = new ArrayList<Car>();
		
		while (resultset.next()){			
			Car mCar = new Car();
			mCar.setTitle(resultset.getString(1));
			mCar.setBrand(resultset.getString(2));
			mCar.setModel(resultset.getString(3));
			mCar.setModelDetail(resultset.getString(4));
			mCar.setYear(resultset.getInt(5));
			mCar.setKm(resultset.getInt(6));
			mCar.setColor(resultset.getString(7));
			mCar.setPrice(resultset.getInt(8));
			mCar.setCity(resultset.getString(9));
			mCar.setTown(resultset.getString(10));
			carList.add(mCar);
		}
		
		if(statement != null)
			statement.close();
		if(connection != null)
			connection.close();
		
		return carList;
	}
	
}
